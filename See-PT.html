<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sounding Data Viewer</title>
    <!-- Include the Tailwind CSS stylesheet -->
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.15/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-100 p-4">
    <div class="max-w-lg mx-auto bg-white p-6 rounded shadow-lg">
        <h1 class="text-2xl font-semibold mb-4">Sounding Data Viewer</h1>
        <input type="file" id="fileInput" class="mb-4">
        <textarea id="fileContents" class="w-full h-32 border rounded p-2 mb-4" placeholder="Paste or edit your data here"></textarea>
        <div id="plot-container1" class="mb-4"></div>
        <div id="plot-container2" class="mb-4"></div>
        <div id="plot-container3" class="mb-4"></div>
        <button id="saveButton" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-700 focus:outline-none focus:shadow-outline-blue active:bg-blue-800">Save</button>
        <button id="removeNegativesButton" class="bg-red-500 text-white px-4 py-2 rounded ml-2 hover:bg-red-700 focus:outline-none focus:shadow-outline-red active:bg-red-800">Remove Negatives</button>
        <button id="addValuesButton" class="bg-green-500 text-white px-4 py-2 rounded ml-2 hover:bg-green-700 focus:outline-none focus:shadow-outline-green active:bg-green-800">Baseline Shift</button>
    </div>

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script>
        const PARAM_PREFIXES = ["D=", "QC=", "FS=", "U="];

        let fileContents = '';
        let soundingData = [];

        function parseSoundingData(data) {
            soundingData = [];
            const lines = data.split('\n');

            for (let i = 0; i < lines.length; i++) {
                if (lines[i].startsWith("D=")) {
                    const d = parseFloat(lines[i].split("=")[1].split(",")[0]);
                    const qc = parseFloat(lines[i].split("=")[2].split(",")[0]);
                    const fs = parseFloat(lines[i].split("=")[3].split(",")[0]);
                    const u = parseFloat(lines[i].split("=")[4].split(",")[0]);
                    const row = { D: d, QC: qc, FS: fs, U: u };
                    soundingData.push(row);
                }
            }
        }

        function generatePlot(data, xKey, yKey, title, xTitle, yTitle) {
            const trace = {
                x: data.map(row => row[xKey]),
                y: data.map(row => row[yKey]),
                mode: "lines+markers",
                type: "scatter",
                name: title,
                marker: {
                    size: 4,
                    colorscale: "Viridis",
                    color: data.map(row => row[yKey])
                }
            };

            const layout = {
                title,
                titlefont: {
                    size: 14
                },
                margin: {
                    t: 20
                },
                xaxis: {
                    title: xTitle
                },
                yaxis: {
                    title: yTitle,
                    autorange: "reversed"
                },
                width: 400,
                height: 700,
                dragmode: 'pan',
                plot_bgcolor: 'transparent',
                paper_bgcolor: 'transparent',
            };

            return { trace, layout };
        }

        function updatePlots(soundingData) {
            const depthData = soundingData.map(row => row.D);
            const tipData = soundingData.map(row => row.QC);
            const frictionData = soundingData.map(row => row.FS);
            const pressureData = soundingData.map(row => row.U);

            const plots = [
                generatePlot(tipData, depthData, "Tip Data", "Tip (kPa)", "Depth (m)"),
                generatePlot(frictionData, depthData, "Friction Data", "Friction (kPa)", "Depth (m)"),
                generatePlot(pressureData, depthData, "Pressure Data", "Pressure (kPa)", "Depth (m)")
            ];

            const config = {
                scrollZoom: true,
                modeBarButtonsToRemove: ['lasso2d', 'select2d'],
                displayModeBar: false,
                responsive: true,
                dragmode: 'pan',
                hovermode: 'closest',
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)'
            };

            const plotContainers = ['plot-container1', 'plot-container2', 'plot-container3'];

            plotContainers.forEach((containerId, index) => {
                const plot = plots[index];
                Plotly.newPlot(containerId, [plot.trace], plot.layout, config);
            });
        }

        const fileInput = document.getElementById("fileInput");
        fileInput.addEventListener("change", function (event) {
            const file = event.target.files[0];
            const reader = new FileReader();

            reader.addEventListener("load", function (event) {
                const contents = event.target.result;
                const decoder = new TextDecoder("windows-1252");
                const decodedContents = decoder.decode(contents);
                fileContents = decodedContents;
                document.getElementById("fileContents").value = decodedContents;
                parseSoundingData(decodedContents);
                updatePlots(soundingData);
            });

            reader.readAsArrayBuffer(file);
        });

        const fileContentsTextArea = document.getElementById("fileContents");
        fileContentsTextArea.addEventListener("input", function (event) {
            fileContents = event.target.value;
            parseSoundingData(fileContents);
            updatePlots(soundingData);
        });

        const saveButton = document.getElementById("saveButton");
        saveButton.addEventListener("click", function () {
            let contents = fileContents;
            contents = contents.replace(/\n/g, "\r\n");
            const importedFile = fileInput.files[0];
            const blob = new Blob([contents], { type: "text/plain;charset=windows-1252" });
            saveAs(blob, importedFile.name);
        });

        const removeNegativesButton = document.getElementById("removeNegativesButton");
        removeNegativesButton.addEventListener("click", function () {
            const parameter = document.getElementById("removeNegativesSelect").value;
            const lines = fileContents.split("\n");
            const regex = new RegExp("(" + parameter + ")=(-\\d+)", "g");

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const updatedLine = line.replace(regex, function (match, p1, p2) {
                    const newValue = p2.substring(1);
                    return p1 + "=" + newValue;
                });
                lines[i] = updatedLine;
            }

            const updatedContents = lines.join("\n");
            fileContents = updatedContents;
            document.getElementById("fileContents").value = updatedContents;
            parseSoundingData(updatedContents);
            updatePlots(soundingData);
        });

        const addValuesButton = document.getElementById("addValuesButton");
        addValuesButton.addEventListener("click", function () {
            const inputValue = parseFloat(document.getElementById("addValuesInput").value);
            const parameter = document.getElementById("addValuesSelect").value;
            const lines = fileContents.split("\n");
            const regex = new RegExp("(" + parameter + ")=(-?\\d+(\\.\\d+)?)", "g");

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const updatedLine = line.replace(regex, function (match, p1, p2) {
                    let newValue = parseFloat(p2) + inputValue;
                    if (p1 === "FS" || p1 === "U") {
                        newValue = newValue.toFixed(1);
                    } else {
                        newValue = newValue.toFixed(4);
                    }
                    return p1 + "=" + newValue.toString();
                });
                lines[i] = updatedLine;
            }

            const updatedContents = lines.join("\n");
            fileContents = updatedContents;
            document.getElementById("fileContents").value = updatedContents;
            parseSoundingData(updatedContents);
            updatePlots(soundingData);
        });
    </script>
</body>
</html>
